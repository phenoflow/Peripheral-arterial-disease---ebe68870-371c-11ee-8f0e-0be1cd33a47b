# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2023.

import sys, csv, re

codes = [{"code":"10827","system":"med"},{"code":"11766","system":"med"},{"code":"12331","system":"med"},{"code":"14895","system":"med"},{"code":"15532","system":"med"},{"code":"16363","system":"med"},{"code":"17336","system":"med"},{"code":"18030","system":"med"},{"code":"18038","system":"med"},{"code":"18060","system":"med"},{"code":"18816","system":"med"},{"code":"20657","system":"med"},{"code":"2066","system":"med"},{"code":"20892","system":"med"},{"code":"21927","system":"med"},{"code":"22016","system":"med"},{"code":"23352","system":"med"},{"code":"24097","system":"med"},{"code":"24229","system":"med"},{"code":"24677","system":"med"},{"code":"24692","system":"med"},{"code":"27580","system":"med"},{"code":"2761","system":"med"},{"code":"28030","system":"med"},{"code":"28119","system":"med"},{"code":"28125","system":"med"},{"code":"28166","system":"med"},{"code":"28616","system":"med"},{"code":"28777","system":"med"},{"code":"28894","system":"med"},{"code":"29112","system":"med"},{"code":"30989","system":"med"},{"code":"31338","system":"med"},{"code":"32492","system":"med"},{"code":"33555","system":"med"},{"code":"34037","system":"med"},{"code":"34153","system":"med"},{"code":"36065","system":"med"},{"code":"36136","system":"med"},{"code":"36443","system":"med"},{"code":"36952","system":"med"},{"code":"3778","system":"med"},{"code":"37787","system":"med"},{"code":"38921","system":"med"},{"code":"39039","system":"med"},{"code":"39437","system":"med"},{"code":"39776","system":"med"},{"code":"39877","system":"med"},{"code":"40302","system":"med"},{"code":"40397","system":"med"},{"code":"40619","system":"med"},{"code":"40732","system":"med"},{"code":"41768","system":"med"},{"code":"41823","system":"med"},{"code":"42115","system":"med"},{"code":"42465","system":"med"},{"code":"42640","system":"med"},{"code":"42645","system":"med"},{"code":"43648","system":"med"},{"code":"43651","system":"med"},{"code":"44250","system":"med"},{"code":"44430","system":"med"},{"code":"45428","system":"med"},{"code":"47562","system":"med"},{"code":"47835","system":"med"},{"code":"48700","system":"med"},{"code":"48755","system":"med"},{"code":"48939","system":"med"},{"code":"49273","system":"med"},{"code":"49319","system":"med"},{"code":"50894","system":"med"},{"code":"51211","system":"med"},{"code":"51331","system":"med"},{"code":"52289","system":"med"},{"code":"52342","system":"med"},{"code":"52357","system":"med"},{"code":"52695","system":"med"},{"code":"52869","system":"med"},{"code":"53580","system":"med"},{"code":"53675","system":"med"},{"code":"54071","system":"med"},{"code":"55402","system":"med"},{"code":"55554","system":"med"},{"code":"55825","system":"med"},{"code":"55877","system":"med"},{"code":"57793","system":"med"},{"code":"59602","system":"med"},{"code":"60212","system":"med"},{"code":"60465","system":"med"},{"code":"60693","system":"med"},{"code":"61255","system":"med"},{"code":"61256","system":"med"},{"code":"61974","system":"med"},{"code":"6256","system":"med"},{"code":"62775","system":"med"},{"code":"62818","system":"med"},{"code":"62866","system":"med"},{"code":"63238","system":"med"},{"code":"63280","system":"med"},{"code":"63368","system":"med"},{"code":"63396","system":"med"},{"code":"6356","system":"med"},{"code":"63605","system":"med"},{"code":"64555","system":"med"},{"code":"64798","system":"med"},{"code":"65286","system":"med"},{"code":"65669","system":"med"},{"code":"65692","system":"med"},{"code":"6617","system":"med"},{"code":"66437","system":"med"},{"code":"66804","system":"med"},{"code":"66820","system":"med"},{"code":"66869","system":"med"},{"code":"66879","system":"med"},{"code":"66917","system":"med"},{"code":"66930","system":"med"},{"code":"67083","system":"med"},{"code":"67818","system":"med"},{"code":"67982","system":"med"},{"code":"68141","system":"med"},{"code":"68320","system":"med"},{"code":"68412","system":"med"},{"code":"69519","system":"med"},{"code":"70922","system":"med"},{"code":"71041","system":"med"},{"code":"7111","system":"med"},{"code":"72448","system":"med"},{"code":"72491","system":"med"},{"code":"73822","system":"med"},{"code":"81445","system":"med"},{"code":"9099","system":"med"},{"code":"9119","system":"med"},{"code":"95573","system":"med"},{"code":"96255","system":"med"},{"code":"96809","system":"med"},{"code":"97606","system":"med"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('peripheral-arterial-disease-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["peripheral-arterial-disease-procedure---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["peripheral-arterial-disease-procedure---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["peripheral-arterial-disease-procedure---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
